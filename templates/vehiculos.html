<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Veh√≠culos - OCR App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>üìã Gesti√≥n de Veh√≠culos</h1>
                <div class="user-section">
                    <span class="user-name">üë§ {{ username }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Cerrar Sesi√≥n</a>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="vehiculos-container">
                <!-- Botones de acci√≥n -->
                <div class="botones-accion">
                    <a href="{{ url_for('captura') }}" class="btn btn-iniciar">
                        <span class="btn-icon">üì∏</span>
                        Iniciar Captura
                    </a>
                    <button id="btn-descargar" class="btn btn-descargar" {% if not vehiculos %}disabled{% endif %}>
                        <span class="btn-icon">üì•</span>
                        Descargar Excel
                    </button>
                </div>

                <!-- Tabla de veh√≠culos -->
                <div class="tabla-section">
                    <h2>Veh√≠culos Registrados</h2>
                    <div class="tabla-wrapper">
                        <table id="tabla-vehiculos" class="tabla-vehiculos">
                            <thead>
                                <tr>
                                    <th>Matr√≠cula</th>
                                    <th>Kilometraje</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if vehiculos %}
                                    {% for vehiculo in vehiculos %}
                                    <tr data-index="{{ loop.index0 }}">
                                        <td class="editable" data-field="matricula">{{ vehiculo.matricula }}</td>
                                        <td class="editable" data-field="kilometros">{{ vehiculo.kilometros }}</td>
                                        <td class="acciones-cell">
                                            <button class="btn-accion btn-editar" onclick="editarVehiculo({{ loop.index0 }})" title="Editar">
                                                <span>‚úèÔ∏è</span>
                                            </button>
                                            <button class="btn-accion btn-eliminar" onclick="eliminarVehiculo({{ loop.index0 }})" title="Eliminar">
                                                <span>üóëÔ∏è</span>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="3" class="empty-message">No hay veh√≠culos registrados</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <p class="tabla-info">Total: <span id="total-vehiculos">{{ vehiculos|length }}</span> veh√≠culo(s)</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Descargar Excel
        document.getElementById('btn-descargar').addEventListener('click', function() {
            if (this.disabled) return;
            
            window.location.href = '{{ url_for("descargar_excel") }}';
        });
        
        // Editar veh√≠culo
        async function editarVehiculo(index) {
            const row = document.querySelector(`tr[data-index="${index}"]`);
            const matriculaCell = row.querySelector('[data-field="matricula"]');
            const kilometrosCell = row.querySelector('[data-field="kilometros"]');
            
            const nuevaMatricula = prompt('Editar matr√≠cula:', matriculaCell.textContent.trim());
            if (nuevaMatricula === null) return; // Cancelado
            
            const nuevosKilometros = prompt('Editar kilometraje:', kilometrosCell.textContent.trim());
            if (nuevosKilometros === null) return; // Cancelado
            
            try {
                const response = await fetch('/editar_vehiculo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        index: index,
                        matricula: nuevaMatricula,
                        kilometros: nuevosKilometros
                    })
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    // Actualizar vista
                    matriculaCell.textContent = nuevaMatricula;
                    kilometrosCell.textContent = nuevosKilometros;
                    alert('Veh√≠culo actualizado correctamente');
                } else {
                    alert('Error al actualizar veh√≠culo: ' + resultado.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar veh√≠culo: ' + error.message);
            }
        }
        
        // Eliminar veh√≠culo
        async function eliminarVehiculo(index) {
            const row = document.querySelector(`tr[data-index="${index}"]`);
            const matricula = row.querySelector('[data-field="matricula"]').textContent.trim();
            
            if (!confirm(`¬øEliminar veh√≠culo con matr√≠cula ${matricula}?`)) {
                return;
            }
            
            try {
                const response = await fetch('/eliminar_vehiculo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ index: index })
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    // Recargar p√°gina para actualizar √≠ndices
                    location.reload();
                } else {
                    alert('Error al eliminar veh√≠culo: ' + resultado.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar veh√≠culo: ' + error.message);
            }
        }
    </script>
</body>
</html>
